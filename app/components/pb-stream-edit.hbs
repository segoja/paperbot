{{#if @isEditing}}
  <div class="card-body">
    <BsForm @formLayout="horizontal" @model={{@stream}} @onSubmit={{this.doneAndReturnEditing}} as |form|>
      <form.element @controlType="text" @label="Stream Title" class="pb-2" placeholder="Stream title" @property="title" required />
      <form.element @controlType="text" @label="Stream Channel" class="pb-2" placeholder="Stream channel" @property="channel" required />
      
      <div class="form-group row pb-2">
        <label class="col-md-4">Stream Monitoring</label>
        <div class="col-sm">
          <form.element @controlType="checkbox" @label="Chat Logging" @formLayout="inline" @property="savechat" class="form-check form-check-inline ps-0"  />
          <form.element @controlType="checkbox" @label="Event Logging" @formLayout="inline" @property="events" class="form-check form-check-inline"  />
          <form.element @controlType="checkbox" @label="Song Request System" @formLayout="inline" @property="requests" class="form-check form-check-inline"  />
        </div>
      </div>
    
      <form.element @controlType="power-select" class="pb-2" @property="botclient" @label="Bot Client" @options={{@clients}} selected={{this.globalConfig.config.defbotclient}} @onChange={{@setBotClient}} required as |client|>
        <client.control @allowClear={{true}} @placeholder="Select the Bot Client for the stream" as |option|>
          {{option.username}}
        </client.control>
      </form.element> 
      <BsButton @type="success" @onClick={{this.doneAndReturnEditing}}><FaIcon @icon="save" /> Save & Return</BsButton> 
      <BsButton @type="secondary" @onClick={{this.doneEditing}}><FaIcon @icon="save" /></BsButton>
      <div class="text-success ms-2 {{if this.saving "d-inline-block fadeout" "d-none"}}"><FaIcon @icon="spinner" class={{if this.saving "spin"}} /> <span>Stream updated!</span></div>
      <ButtonConfirm @btnClass="btn btn-danger float-end" @btnIcon="trash" @btnText="Delete" @confirmDescription="Are you sure you want to delete this stream?" @targetAction={{@deleteStream}} />
    </BsForm>
  </div>
{{else}}
  <div class="card-body p-0 bg-dark">
    <div class="row g-0 bg-dark border border-dark">
      {{#if this.currentUser.isTauri}}
        <BsButton class="btn-sm col-auto col-sm-auto border rounded-0" @type={{if this.audio.SBstatus "info" "secondary"}} @onClick={{this.audio.toggle}} title="Enable/disable soundboard">
          {{on-key "ctrl+KeyM" this.audio.toggle}}  
          <FaIcon @icon={{if this.audio.SBstatus "volume-up" "volume-mute"}} /> Soundboard
        </BsButton>
      {{/if}}
      <div class="col">
        <div class="row g-0">  
          <BsButton class="btn-sm col-12 col-sm border rounded-0" @type={{if @stream.requests (if this.currentUser.updateQueueOverlay "warning" "secondary") "secondary"}} @onClick={{this.queueWriter}} title="Enable/disable queue overlay">
            {{#if @stream.requests}} {{on-key "ctrl+KeyN" this.queueWriter}} {{/if}}
            {{#unless @stream.requests}}
              <BsTooltip @delayHide={{this.globalConfig.ttdelay}}>Please, enable the <em>Song Request System</em></BsTooltip>
            {{/unless}}
            <FaIcon @icon={{if @stream.requests (if this.currentUser.updateQueueOverlay "file-alt" "file") "file"}} /> Requests
          </BsButton>          
          {{#if this.disableBotButton}}
            <BsButton class="btn-sm col-12 col-sm border rounded-0" @type={{if this.twitchChat.botConnected "primary" "secondary"}} disabled={{this.disableBotButton}}><FaIcon @icon="play" /> Bot</BsButton>
          {{else}}      
            <BsButton class="btn-sm col-12 col-sm border rounded-0" disabled={{unless (or this.optsbot this.twitchChat.botConnected) true}} @type={{if this.twitchChat.botConnected "primary" "secondary"}} @onClick={{fn (if this.twitchChat.botConnected this.disconnectBot this.connectBot)}}>
              <FaIcon @icon={{if this.twitchChat.botConnected "stop" "play"}} /> Bot
            </BsButton>
          {{/if}}
        </div>
      </div>
      <div class="col">
        <div class="row g-0"> 
          <BsButton class="btn-sm col-12 col-sm text-truncate border rounded-0" @type="danger" @onClick={{this.finishStream}} disabled={{if this.twitchChat.botConnected false (if @stream.finished this.disconnectButton true)}}><FaIcon @icon="flag-checkered" /> Stop & Save</BsButton>
          <BsButton class="btn-sm col col-sm text-editstream text-truncate border rounded-0" @type="warning" @onClick={{@editStream}}><FaIcon @icon="edit" /> Edit Stream</BsButton>
        </div>
      </div>
    </div>
    {{#unless @stream.finished}}
      {{#if this.currentUser.isTauri}}
        <SoundboardLoading />
      {{/if}}
    {{/unless}}
  </div>
  {{#unless @stream.finished}}  
    {{#if this.twitchChat.botConnected}}
      <div class="card-body p-0 m-0 pan-buttons-row">
        <div class="row p-0 m-0">
          {{#if @stream.events}}
            {{#if this.globalConfig.config.extraPanLeft}}
              <button type="button" class="col border alert-secondary p-0 m-0" disabled={{not this.globalConfig.config.extraPanLeft}} {{on "click" this.toggleExtraPanLeftTop}}>
                <FaIcon @icon={{if this.globalConfig.config.extraPanLeftTop "grip-lines" "ellipsis-h"}} class="d-block mx-auto" />
              </button>
            {{/if}}
          {{else}}
            {{#if this.globalConfig.config.extraPanLeft}}          
              <div class="col border alert-secondary p-0 m-0"></div>
            {{/if}}
          {{/if}}
          {{#if this.requests}}
            {{#if this.globalConfig.config.extraPanRight}}          
              <button type="button" class="{{if this.globalConfig.config.extraPanLeft "col-5" "col"}} border alert-secondary p-0 m-0" {{on "click" this.toggleExtraPanRightTop}}>
                <FaIcon @icon={{if this.globalConfig.config.extraPanRightTop "grip-lines" "ellipsis-h"}} class="d-block mx-auto" />
              </button>
            {{/if}}
          {{/if}}
          {{#if (and (not this.globalConfig.config.extraPanLeft) (not this.globalConfig.config.extraPanRight))}}          
            <div class="col border alert-secondary p-0 m-0"></div>
          {{/if}}
        </div>
      </div>
      <div class="card-body p-0 m-0 flex-fill d-flex h-100 overflow-hidden">
        <Dragula class="row flex-fill d-flex h-100 mx-0 px-0 overflow-hidden" @options={{hash moves=this.moves}} as |Container|>
          <button type="button" class="h-100 d-flex border alert-secondary col-auto px-0" {{on "click" this.toggleExtraPanLeft}}>
            <span class="d-block align-self-center"><FaIcon @icon={{if this.globalConfig.config.extraPanLeft "grip-lines-vertical" "ellipsis-v"}} /></span>
          </button>
         <div class="{{if this.globalConfig.config.noPanels "col h-100 border m-0 p-0" "d-none"}}"></div>
          <div class="{{if this.globalConfig.config.extraPanLeft "col h-100 border m-0 p-0" "d-none"}}">
              <div class="row m-0 p-0 {{if @stream.events (if this.globalConfig.config.extraPanLeftTop (if this.globalConfig.config.extraPanLeftBottom "h-25" "h-100") "d-none")  "d-none"}} border">          
                <Container class="col h-100 border m-0 p-0">
                   <PbStreamEditEvents @stream={{@stream}} />
                </Container>
              </div>          
            <div class="row m-0 p-0 {{if this.globalConfig.config.extraPanLeftBottom (if this.globalConfig.config.extraPanLeftTop (if @stream.events "h-75" "h-100") "h-100") "d-none"}} border">
              <Container class="col h-100 border m-0 p-0">
                <PbStreamEditChat @stream={{@stream}} />
              </Container>
            </div>
          </div>
          {{#if this.requests}}
            {{on-key "ctrl+Period" this.queueHandler.nextSong}}
            {{on-key "ctrl+Comma" this.queueHandler.prevSong}}
            {{on-key "ctrl+KeyQ" this.queueHandler.modPressed event="keypress"}} 
            {{on-key "ctrl+KeyQ" this.queueHandler.modNotPressed event="keyup"}}
          {{/if}}
          <div class="{{if this.requests (if this.globalConfig.config.extraPanRight (if this.globalConfig.config.extraPanLeft "col-5 h-100 border  m-0 p-0" "col h-100 border  m-0 p-0") "d-none")}}">
            <div class="row m-0 p-0 {{if this.globalConfig.config.extraPanRightTop (if this.globalConfig.config.extraPanRightBottom "h-50" "h-100") "d-none"}} border">
              <Container class="col h-100 m-0 p-0"> 
                <PbStreamEditPending @requests={{this.requests}} />
              </Container>
            </div>
            <div class="row m-0 p-0 {{if this.globalConfig.config.extraPanRightBottom (if this.globalConfig.config.extraPanRightTop "h-50" "h-100") "d-none"}} border">
              <Container class="col h-100 m-0 p-0"> 
                <PbStreamEditPlayed @requests={{this.requests}} />
              </Container>        
            </div>
          </div>
        </Dragula>
        <button type="button" class="h-100 d-flex border alert-secondary col-auto px-0" {{on "click" this.toggleExtraPanRight}}>
          <span class="d-block align-self-center"><FaIcon @icon={{if this.globalConfig.config.extraPanRight "grip-lines-vertical" "ellipsis-v"}} /></span>
        </button>
      </div>
      <div class="card-body p-0 m-0 pan-buttons-row">
        <div class="row p-0 m-0">
          {{#if @stream.events}}
            {{#if this.globalConfig.config.extraPanLeft}}
              <button type="button" class="col border alert-secondary p-0 m-0" disabled={{not this.globalConfig.config.extraPanLeft}} {{on "click" this.toggleExtraPanLeftBottom}}>
                <FaIcon @icon={{if this.globalConfig.config.extraPanLeftBottom "grip-lines" "ellipsis-h"}} class="d-block mx-auto" />
              </button>
            {{/if}}
          {{else}}
            {{#if this.globalConfig.config.extraPanLeft}}          
              <div class="col border alert-secondary p-0 m-0"></div>
            {{/if}}
          {{/if}}
          {{#if this.requests}}
            {{#if this.globalConfig.config.extraPanRight}}
              <button type="button" class="{{if this.globalConfig.config.extraPanLeft "col-5" "col"}} border alert-secondary p-0 m-0" {{on "click" this.toggleExtraPanRightBottom}}>
                <FaIcon @icon={{if this.globalConfig.config.extraPanRightBottom "grip-lines" "ellipsis-h"}} class="d-block mx-auto" />
              </button>
            {{/if}}
          {{/if}}
          {{#if (and (not this.globalConfig.config.extraPanLeft) (not this.globalConfig.config.extraPanRight))}}          
            <div class="col border alert-secondary p-0 m-0"></div>
          {{/if}}
        </div>
      </div>
    {{/if}}
  {{/unless}}
{{/if}}
